# 架构设计 - Bot 语音沟通项目

## 概述

本设计文档记录 Bot 语音沟通项目的完整技术架构，包括 Vue 3 前端、Python Flask 后端（阿里云百炼大模型）、阿里云语音服务（ASR/TTS）集成。

## 当前环境

| 项目 | 配置 |
|-----|------|
| 设备 | MacBook Pro |
| 平台 | **Intel x86_64** |
| 操作系统 | macOS 15.7.3 |
| CPU | Intel Core 系列 |
| 内存 | 8GB+ RAM |
| 存储 | 10GB+ |

**特殊说明**：
- Intel 平台无 Neural Engine，需依赖 CPU/GPU
- 使用 Python venv 管理后端环境

---

## 技术选型决策

### 对话模型：阿里云百炼大模型

| 维度 | 阿里云百炼 | OpenAI | MiniMax |
|-----|-----------|--------|---------|
| **中文优化** | ✅ 强 | 一般 | ✅ 强 |
| **价格** | 适中 | 较高 | ✅ 便宜 |
| **API 稳定性** | ✅ 企业级 | ✅ 企业级 | ✅ 稳定 |
| **集成经验** | ✅ 熟悉 | - | - |

### 语音服务：阿里云智能语音

| 维度 | 阿里云 | 百度 | 讯飞 |
|-----|--------|------|------|
| **ASR 实时识别** | ✅ 支持 | ✅ 支持 | ✅ 支持 |
| **TTS 语音合成** | ✅ 支持 | ✅ 支持 | ✅ 支持 |
| **方言支持** | ✅ 强 | 一般 | ✅ 强 |

**最终选择**：
- **对话模型**: 阿里云百炼（qwen-turbo/plus/max）
- **语音服务**: 阿里云智能语音（ASR + TTS）
- **前端**: Vue 3 + Vite + Pinia + Vue Router
- **后端**: Python Flask + Requests

---

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      前端 (Vue 3 + Vite)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────────┐    ┌────────────────┐  │
│  │ 语音输入    │───▶│ 阿里云 ASR      │───▶│ 文本确认/发送  │  │
│  │ (VoiceInput)│    │ 实时语音转文字  │    │ 用户确认       │  │
│  └─────────────┘    └─────────────────┘    └────────┬───────┘  │
│                                                      │          │
│  ┌─────────────┐    ┌─────────────────┐    ┌────────▼────────┐ │
│  │ 语音播放    │◀───│ 阿里云 TTS      │◀───│  Flask 后端     │ │
│  │ (Audio)     │    │ 文字转语音      │    │  /api/chat      │ │
│  └─────────────┘    └─────────────────┘    └─────────────────┘ │
│                                    ▲              │             │
│                                    │              │             │
│  ┌─────────────────────────────────┴──────────────┘             │
│  │                    用户认证 (API Key)                        │
│  │  - 前端输入 API Key                                        │
│  │  - 后端验证有效性                                          │
│  │  - 存储在 localStorage                                     │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                   ┌────────────────────┐
                   │  阿里云百炼 API     │
                   │  (DashScope)       │
                   └────────────────────┘
```

---

## 技术栈

| 层级 | 技术 | 说明 |
|-----|------|------|
| **前端框架** | Vue.js 3 | Composition API |
| **构建工具** | Vite | 开发服务器 |
| **状态管理** | Pinia | 用户/对话状态 |
| **路由** | Vue Router | 页面路由 |
| **HTTP 客户端** | Axios | API 请求 |
| **后端框架** | Flask | Python Web 框架 |
| **LLM 客户端** | Requests | DashScope API |
| **认证** | API Key | X-API-Key Header |

---

## 前端项目结构

```
code/frontend/
├── src/
│   ├── api/
│   │   └── openclaw.js       # Axios 请求封装（含认证拦截器）
│   ├── components/
│   │   ├── VoiceInput.vue    # 语音输入按钮组件
│   │   └── MessageBubble.vue # 消息气泡组件
│   ├── composables/
│   │   └── useVoiceRecord.js # 语音录制组合式函数
│   ├── router/
│   │   └── index.js          # Vue Router 配置
│   ├── services/
│   │   ├── asr.js            # 阿里云 ASR 实时语音识别
│   │   ├── tts.js            # 阿里云 TTS 语音合成
│   │   └── openclaw.js       # 后端 API 服务（含 Key 验证）
│   ├── stores/
│   │   ├── auth.js           # API Key 认证状态
│   │   └── chat.js           # 对话消息状态
│   ├── styles/
│   │   └── main.css          # 全局样式
│   ├── views/
│   │   ├── ChatView.vue      # 主对话页面
│   │   └── SettingsView.vue  # 设置页面（API Key 配置）
│   ├── App.vue
│   └── main.js
├── .env.example              # 环境变量示例
├── package.json
├── vite.config.js
└── README.md
```

### 前端核心模块

| 模块 | 文件 | 功能 |
|-----|------|------|
| **语音输入** | VoiceInput.vue | 按住录音 + ASR 实时转写 |
| **语音合成** | tts.js | 文本转语音播放 |
| **后端通信** | openclaw.js | Key 验证 + 对话请求 |
| **状态管理** | auth.js | Key 存储和验证状态 |

---

## 后端项目结构

```
code/backend/
├── main.py           # DashScope 客户端 + Flask API（原始版）
├── auth_api.py       # API Key 认证系统 + 集成版
├── requirements.txt  # Python 依赖
├── .env.example      # 环境变量示例
├── api_keys.json     # API Keys 存储（自动生成）
└── README.md         # 使用文档
```

### 后端核心模块 (auth_api.py)

| 功能 | 端点 | 方法 | 认证 |
|-----|------|------|------|
| **健康检查** | /health | GET | ❌ |
| **模型列表** | /api/models | GET | ❌ |
| **创建 Key** | /api/keys | POST | ❌ |
| **列出 Keys** | /api/keys | GET | ❌ |
| **删除 Key** | /api/keys/{id} | DELETE | ❌ |
| **对话接口** | /api/chat | POST | ✅ X-API-Key |

### API Key 认证流程

```
1. 前端 → POST /api/keys (name: "Web")
2. 后端 → 返回 { id, key: "bk_xxx...", name }
3. 前端 → 存储 Key 到 localStorage
4. 前端 → POST /api/chat (Header: X-API-Key: bk_xxx...)
5. 后端 → 验证 Key 有效性 → 调用 DashScope API → 返回结果
```

---

## API 接口设计

### 对话接口

**POST** `/api/chat`

**请求头**:
```
X-API-Key: bk_xxxxxxxxxxxxxxxxxxxx
Content-Type: application/json
```

**请求体**:
```json
{
  "messages": [
    {"role": "system", "content": "你是一个助手"},
    {"role": "user", "content": "你好"}
  ],
  "model": "qwen-turbo",
  "temperature": 0.7,
  "max_tokens": 2000
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "output": {
      "text": "你好！有什么可以帮助你的？"
    },
    "usage": {
      "input_tokens": 17,
      "output_tokens": 20
    }
  },
  "timestamp": "2026-01-30T22:30:00"
}
```

### API Key 管理

**创建 Key**
```bash
POST /api/keys
Content-Type: application/json

{"name": "Web Frontend"}
```

**响应**:
```json
{
  "success": true,
  "key": {
    "id": "20260130223000",
    "name": "Web Frontend",
    "key": "bk_xxxxxxxxxxxxxxxxxxxx",
    "created_at": "2026-01-30T22:30:00"
  }
}
```

---

## 目录结构总览

```
bot语音沟通/
├── README.md
├── 设计文档/
│   ├── 架构设计.md       # 本文档
│   └── 接口设计.md       # 详细 API 接口文档（待编写）
└── 代码实现/
    ├── backend/         # Python Flask 后端
    │   ├── main.py      # DashScope 客户端
    │   ├── auth_api.py  # API Key 认证系统
    │   ├── requirements.txt
    │   └── api_keys.json
    │
    └── frontend/        # Vue 3 前端
        ├── src/
        │   ├── api/openclaw.js
        │   ├── components/
        │   ├── services/
        │   ├── stores/
        │   └── views/
        ├── package.json
        └── vite.config.js
```

---

## 本地开发配置

### 后端

```bash
# 创建虚拟环境
cd code/backend
python3 -m venv bot-voice-env
source bot-voice-env/bin/activate
pip install -r requirements.txt

# 启动服务
export DASHSCOPE_API_KEY="sk-xxx"
python auth_api.py --port 5002

# 或使用 Flask CLI 创建 API Key
flask create-key
```

### 前端

```bash
cd code/frontend
npm install
npm run dev
```

### 环境变量

**后端 (.env)**
```bash
DASHSCOPE_API_KEY=sk-xxxxxxxx
```

**前端 (.env.example)**
```bash
VITE_API_URL=http://localhost:5002
```

---

## 开发进度

### ✅ Phase 1: 基础框架
- [x] 初始化 Vue 3 + Vite 项目
- [x] 配置路由和 Pinia 状态管理
- [x] 实现 API Key 认证系统
- [x] 实现 Python Flask 后端

### Phase 2: 语音功能
- [ ] 集成阿里云 ASR 实时识别
- [ ] 集成阿里云 TTS 语音合成
- [x] 实现语音输入组件 (VoiceInput.vue)
- [ ] 实现语音播放组件

### Phase 3: 对话集成
- [x] 实现后端对话 API (/api/chat)
- [x] 实现前端对话服务
- [ ] 完整流程联调

### Phase 4: 优化完善
- [ ] 添加持续监听模式
- [ ] 优化用户体验
- [ ] 错误处理和重试

---

## 安全机制

### API Key 管理

| 措施 | 说明 |
|-----|------|
| **密钥哈希** | 只保存 SHA256 哈希值 |
| **Key 前缀** | `bk_` 前缀标识 Bot Key |
| **启用/禁用** | 可随时禁用泄露的 Key |
| **使用追踪** | 记录最后使用时间 |

### 请求验证

```python
def require_api_key(f):
    @wraps(f)
    def decorated(*args, **kwargs):
        api_key = request.headers.get('X-API-Key')
        
        if not api_key:
            return jsonify({'error': 'Missing API Key'}), 401
        
        # 验证 Key 是否有效
        # ...
        
        return f(*args, **kwargs)
    return decorated
```

---

## 成本估算

### 阿里云百炼大模型

| 模型 | 价格 | 适用场景 |
|-----|------|---------|
| qwen-turbo | ¥0.008/千tokens | 日常对话 |
| qwen-plus | ¥0.02/千tokens | 复杂任务 |
| qwen-max | ¥0.06/千tokens | 高质量回答 |

**月均成本估算**（1000次对话，每次500 tokens）:
- Turbo: ~¥4/月
- Plus: ~¥10/月
- Max: ~¥30/月

---

## 更新记录

- 2026-01-30: 初版设计，选用阿里云智能语音服务
- 2026-01-30: 更新架构，新增 Python Flask 后端 + API Key 认证系统

---

## 创建时间

2026-01-30
最后更新: 2026-01-30
